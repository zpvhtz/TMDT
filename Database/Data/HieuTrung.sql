USE QLBanGiay
GO
--
INSERT INTO LoaiNguoiDung
	VALUES ('75523BB6-C366-4A28-A85C-B4C8C1D5747A', 'USR-WMT', N'Webmaster', N'Không khoá'),
		   ('15CF8A9B-517E-4BAE-91E2-F30C596990ED', 'USR-CUS', N'Khách hàng', N'Không khoá'),
		   ('EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', 'USR-MER', N'Thương nhân', N'Không khoá')

INSERT INTO TaiKhoan
	VALUES('CA2EE7E2-7F64-4A5A-A49B-E22E9E05F053', 'merchant1', 'F98919752BF9BFB31E539A1FE663FD68', 'hieu.trung.030197@gmail.com', N'Hiếu Trung', '09354268754', '654238415', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
	      ('18D79B1D-EE48-459A-AD1D-09A05A4773AD', 'merchant2', '8B550A0CA911A53B1C6FC398C7828F40', 'tnngo.97@gmail.com', N'Thị Nho', '09345123654', '356984126', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
		  ('499A28F6-67A2-4D2D-B027-183058A07646', 'merchant3', '3E99AD8EE3FBCBFA3D369D7FB0B0EA89', 'merchant03@gmail.com', N'Thanh Thảo', '0935426714', '657135426', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
		  ('739E7B3F-D6B8-4C48-81B4-487B75589E80', 'merchant4', 'DBB63DEE74EAD9034DEFD63D91D197E9', 'merchant04@gmail.com', N'Bá Đông', '0936582613', '958743265', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
		  ('9D042E88-B462-4811-9FED-4CC6A1C7A3AC', 'merchant5', 'B522147E61BA70E1757ADF4988757BCA', 'merchant05@gmail.com', N'Lý Thành', '0934513559', '154786254', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
		  ('1A31055B-A4BB-4BD7-81AB-1792CEB4B080', 'merchant6', 'F0277B130FA4966F39FD1986168DC042', 'merchant06@gmail.com', N'Quốc Thắng', '0937423651', '597326549', 'EA9FC9A5-9C26-40A4-9E8E-BB3DAE4E0156', GETDATE(), 0, N'Không khoá'),
		  ('0C2F1A1B-6412-4FE2-B229-5FCE555349FC', 'customer1', 'FFBC4675F864E0E9AAB8BDF7A0437010', 'chunglinhdan@gmail.com', N'Trang Thảo', '0934851349', '954134782', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('1FFCCD2B-D22D-4F01-8E5B-2CA3B690D5D7', 'customer2', '5CE4D191FD14AC85A1469FB8C29B7A7B', 'quachdaivy7@gmail.com', N'Đại Vĩ', '0935684251', '597268451', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('7C24DC80-B487-40D2-A656-B6358962BBF5', 'customer3', '033F7F6121501AE98285AD77F216D5E7', 'customer3@gmail.com', N'Anh Vũ', '0934621574', '684326519', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('1D154C23-D7F1-47C6-8E3A-4CA13CBC837D', 'customer4', '55FEB130BE438E686AD6A80D12DD8F44', 'customer4@gmail.com', N'Kiến Vinh', '0934625795', '132574985', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('EA550E6B-34F1-45F7-BEAB-52435507FD03', 'customer5', '9E8486CDD435BEDA9A60806DD334D964', 'customer5@gmail.com', N'Anh Dũng', '0931652346', '953264158', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('5FED6DA6-45E0-4825-8B03-689E30C5EC17', 'customer6', 'DBAA8BD25E06CC641F5406027C026E8B', 'customer6@gmail.com', N'Minh Bảo', '0934851362', '745632658', '15CF8A9B-517E-4BAE-91E2-F30C596990ED', GETDATE(), NULL, N'Không khoá'),
		  ('87186AF2-0D45-4ACD-898D-D799728C08AE', 'admin', '21232F297A57A5A743894A0E4A801FC3', 'feast.pock@gmail.com', N'Thiên Tuấn', '0934816735', '341267458', '75523BB6-C366-4A28-A85C-B4C8C1D5747A', GETDATE(), NULL, N'Không khoá'),
		  ('8634C513-90FB-4DB7-9E80-F8278ECDEF68', 'admin2', 'C84258E9C39059A89AB77D846DDAB909', 'admin2@gmail.com', N'Hoàng Tuấn', '0934125436', '6598742365', '75523BB6-C366-4A28-A85C-B4C8C1D5747A', GETDATE(), NULL, N'Không khoá')

INSERT INTO DiaChi
	VALUES('A42E13C6-0AAE-469C-B5A1-3ECDDC7767EB', 'CA2EE7E2-7F64-4A5A-A49B-E22E9E05F053', N'209 Trần Phú P4 Q5', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('239C76CD-7C6B-4F38-8D1A-22080B75C18C', 'CA2EE7E2-7F64-4A5A-A49B-E22E9E05F053', N'94 Nguyễn Chí Thanh P3 Q10', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('CC133D4A-805C-456A-BD6A-F735561DEDA6', '18D79B1D-EE48-459A-AD1D-09A05A4773AD', N'386 Lê Hồng Phong P1 Q10', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('012D35DA-6F9F-477B-B6D9-4D3190AC539F', '499A28F6-67A2-4D2D-B027-183058A07646', N'S322B Quốc lộ 62 P6', 'EF349D02-B36F-4BB5-B52E-152454BF2454', N'Không khoá'),
		  ('7B1C2C92-4C07-46E1-A5E5-644A766F023E', '739E7B3F-D6B8-4C48-81B4-487B75589E80', N'92A Tán Kế P3', '00FEDBBC-6BBA-4BB7-80B8-66A5E3AFF7CC', N'Không khoá'),
		  ('447076CA-E76C-4CF6-A55E-62C68F6B18E9', '9D042E88-B462-4811-9FED-4CC6A1C7A3AC', N'49 Cách Mạng Tháng Tám P3', '00FEDBBC-6BBA-4BB7-80B8-66A5E3AFF7CC', N'Không khoá'),
		  ('38E1D107-A4E9-4C6C-AB50-3B4DFA5573D4', '1A31055B-A4BB-4BD7-81AB-1792CEB4B080', N'466C5 Nguyễn Huệ P.Phú Khương', '00FEDBBC-6BBA-4BB7-80B8-66A5E3AFF7CC', N'Không khoá'),
		  ('9B71D7CA-08F7-403B-BA95-38D2E4BDE140', '0C2F1A1B-6412-4FE2-B229-5FCE555349FC', N'236 Phó Cơ Điều P6 Q11', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('DF75434B-4CB4-4515-9A44-FB8239CA6AD7', '0C2F1A1B-6412-4FE2-B229-5FCE555349FC', N'440 Trần Văn Đang P10 Q3', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('C7120B3E-B986-4A98-AACF-36CF83D124C7', '1FFCCD2B-D22D-4F01-8E5B-2CA3B690D5D7', N'289 Lãnh Binh Thăng P8 Q11', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('700FC48E-6033-440F-9DFE-4D7A137A1251', '7C24DC80-B487-40D2-A656-B6358962BBF5', N'220 Nguyễn Tri Phương Q.Thanh Khê', '005A59B7-3812-4B23-B154-D8894AB92905', N'Không khoá'),
		  ('32D3A808-0F76-473F-8BE0-80BCC6489DA5', '1D154C23-D7F1-47C6-8E3A-4CA13CBC837D', N'39 Núi Thành Q.Hải Châu', '005A59B7-3812-4B23-B154-D8894AB92905', N'Không khoá'),
		  ('424C7F44-CAC8-4228-93EF-A7B0FC80E058', 'EA550E6B-34F1-45F7-BEAB-52435507FD03', N'38 Trần Cao Vân', 'AD60B8AA-732B-4546-9EB1-0E0E565D3417', N'Không khoá'),
		  ('F0A0BEC1-F0EF-41AD-9311-57CF95177F33', '5FED6DA6-45E0-4825-8B03-689E30C5EC17', N'80 Mai Thúc Loan, Thuận Lộc', 'AD60B8AA-732B-4546-9EB1-0E0E565D3417', N'Không khoá'),
		  ('752E8997-23E9-4DC4-8529-5FBC68066895', '87186AF2-0D45-4ACD-898D-D799728C08AE', N'482 Hồng Bàng P6 Q6', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá'),
		  ('8D644CFB-1075-4895-AA04-4EC46EA6B786', '8634C513-90FB-4DB7-9E80-F8278ECDEF68', N'56 Bành Văn Trân P7 Q.Tân Bình', '1D683773-5757-4C4E-BE2B-5537B5F567BD', N'Không khoá')

INSERT INTO GianHang
	VALUES('2AE717B5-01AC-47DB-97FF-550130D1C537', 'GH-1', N'Gói 1 tháng', 400000, 1),
		  ('3AE382C3-D4D9-44ED-8D0C-DBFA911A13BA', 'GH-2', N'Gói 2 tháng', 780000, 2),
		  ('9FDEDF57-2F92-40B9-81CA-96A37472A81E', 'GH-3', N'Gói 6 tháng', 2200000, 6),
		  ('80FF7A53-99C8-4505-AA5A-F19F1D82A5C6', 'GH-4', N'Gói 1 năm', 4200000, 12)

INSERT INTO LichSuGianHang
	VALUES('B1AD6C00-2136-476A-A120-1CCBAB3147F2', 'CA2EE7E2-7F64-4A5A-A49B-E22E9E05F053', '80FF7A53-99C8-4505-AA5A-F19F1D82A5C6', GETDATE()),
		  ('B4000F6F-DE84-4467-92B9-3FAF28CB9F4C', '18D79B1D-EE48-459A-AD1D-09A05A4773AD', '9FDEDF57-2F92-40B9-81CA-96A37472A81E', GETDATE()),
		  ('F15D5293-3369-45A9-93D3-BE3D5D00378F', '499A28F6-67A2-4D2D-B027-183058A07646', '3AE382C3-D4D9-44ED-8D0C-DBFA911A13BA', GETDATE()),
		  ('1640280A-A9BC-485C-8FD1-5A3A3D2546A7', '739E7B3F-D6B8-4C48-81B4-487B75589E80', '2AE717B5-01AC-47DB-97FF-550130D1C537', GETDATE())
GO

--CREATE TRIGGER TG_ThemThoiGian_GianHang ON LichSuGianHang AFTER INSERT
--AS
--	DECLARE @IdLichSuGianHang UNIQUEIDENTIFIER
--	DECLARE @IdTaiKhoan UNIQUEIDENTIFIER
--	DECLARE @IdGianHang UNIQUEIDENTIFIER
--	DECLARE @ThoiGian INT
--	DECLARE @ThoiHanGianHang DATETIME
--	--
--	DECLARE CUR CURSOR FOR
--	SELECT i.Id, i.IdTaiKhoan, i.IdGianHang, g.ThoiGian
--	FROM inserted i JOIN GianHang g ON i.IdGianHang = g.Id
--	--
--	OPEN CUR
--	FETCH NEXT FROM CUR INTO @IdLichSuGianHang, @IdTaiKhoan, @IdGianHang, @ThoiGian
--	WHILE @@FETCH_STATUS = 0
--	BEGIN
--		SELECT @ThoiHanGianHang = ThoiHanGianHang
--		FROM TaiKhoan
--		WHERE Id = @IdTaiKhoan
--		--
--		IF(@ThoiHanGianHang < GETDATE())
--		BEGIN
--			--Update LichSuGianHang--
--			UPDATE LichSuGianHang
--			SET NgayBatDau = GETDATE(), NgayKetThuc = DATEADD(DAY, @ThoiGian, GETDATE())
--			WHERE Id = @IdLichSuGianHang
--			--Update TaiKhoan--
--			UPDATE TaiKhoan
--			SET ThoiHanGianHang = DATEADD(DAY, @ThoiGian, GETDATE())
--			WHERE Id = @IdTaiKhoan
--		END
--		ELSE
--		BEGIN
--			--Update LichSuGianHang--
--			UPDATE LichSuGianHang
--			SET NgayBatDau = @ThoiHanGianHang, NgayKetThuc = DATEADD(DAY, @ThoiGian, @ThoiHanGianHang)
--			WHERE Id = @IdLichSuGianHang
--			--Update TaiKhoan--
--			UPDATE TaiKhoan
--			SET	ThoiHanGianHang = DATEADD(DAY, @ThoiGian, ThoiHanGianHang)
--			WHERE Id = @IdTaiKhoan
--		END
--		FETCH NEXT FROM CUR INTO @IdTaiKhoan, @IdGianHang, @ThoiGian
--	END
--	CLOSE CUR
--	DEALLOCATE CUR
--GO

--CREATE TRIGGER TG_SuaThoiGian_GianHang ON LichSuGianHang AFTER UPDATE
--AS
--	DECLARE @ThoiGian INT
--	DECLARE @IdTaiKhoan UNIQUEIDENTIFIER
--	--
--	SELECT @IdTaiKhoan = i.IdTaiKhoan, @ThoiGian = g.ThoiGian
--	FROM inserted i JOIN GianHang g ON i.IdGianHang = g.Id
--	--
--	UPDATE TaiKhoan
--	SET ThoiHanGianHang = DATEADD(DAY, -@ThoiGian, ThoiHanGianHang)
--	WHERE Id = @IdTaiKhoan
--GO

CREATE TRIGGER TG_TruSoLuong_SizeSanPham_ChiTietPhieuDat ON ChiTietPhieuDat AFTER INSERT
AS
	DECLARE @IdSizeSanPham UNIQUEIDENTIFIER
	DECLARE @SoLuong INT
	--
	SELECT @IdSizeSanPham = IdSizeSanPham, @SoLuong = SoLuong
	FROM inserted
	--
	UPDATE SizeSanPham
	SET SoLuong = SoLuong - @SoLuong
	WHERE Id = @IdSizeSanPham
GO

CREATE TRIGGER TG_CongSoLuong_SizeSanPham_PhieuDat ON PhieuDat AFTER UPDATE
AS
	DECLARE @IdPhieuDat UNIQUEIDENTIFIER
	DECLARE @TinhTrang NVARCHAR(20)
	--
	SELECT @IdPhieuDat = Id, @TinhTrang = TinhTrang
	FROM inserted
	--
	IF(@TinhTrang = N'Đã huỷ')
	BEGIN
		DECLARE @IdSizeSanPham UNIQUEIDENTIFIER
		DECLARE @SoLuong INT
		--
		DECLARE CUR CURSOR FOR
		SELECT IdSizeSanPham, SoLuong
		FROM ChiTietPhieuDat
		WHERE IdPhieuDat = @IdPhieuDat
		--
		OPEN CUR
		FETCH NEXT FROM CUR INTO @IdSizeSanPham, @SoLuong
		WHILE @@FETCH_STATUS = 0
		BEGIN
			UPDATE SizeSanPham
			SET SoLuong = SoLuong + @SoLuong
			WHERE Id = @IdSizeSanPham
			--
			FETCH NEXT FROM CUR INTO @IdSizeSanPham, @SoLuong
		END
		CLOSE CUR
		DEALLOCATE CUR
	END
GO

CREATE TRIGGER TG_ThemPhieuGiao_PhieuDat ON PhieuDat AFTER UPDATE
AS
	DECLARE @TinhTrang NVARCHAR(20)
	DECLARE @IdTaiKhoan UNIQUEIDENTIFIER
	DECLARE @IdPhieuDat UNIQUEIDENTIFIER
	DECLARE @DiaChi NVARCHAR(200)
	DECLARE @TongTien FLOAT
	--
	SELECT @TinhTrang = TinhTrang, @IdTaiKhoan = IdTaiKhoan, @DiaChi = DiaChi, @TongTien = TongTien, @IdPhieuDat = Id
	FROM inserted
	--
	IF(@TinhTrang = N'Đã xác nhận')
	BEGIN
		DECLARE @MaPhieuGiao VARCHAR(10)
		--Lấy mã phiếu giao mới nhất--
		SELECT TOP 1 @MaPhieuGiao = MaPhieuGiao
		FROM PhieuGiao
		ORDER BY CAST(SUBSTRING(MaPhieuGiao, 4, LEN(MaPhieuGiao)) AS INT) DESC
		--
		DECLARE @IdPhieuGiao UNIQUEIDENTIFIER
		SET @IdPhieuGiao = NEWID()
		--
		IF(@MaPhieuGiao IS NULL)
		BEGIN
			INSERT INTO PhieuGiao
				VALUES(@IdPhieuGiao, 'PG-1', '', @IdTaiKhoan, @DiaChi, GETDATE(), '', @TongTien, NULL, N'Đang chuẩn bị')
		END
		ELSE
		BEGIN
			--Lấy mã mới--
			DECLARE @STT INT = CAST(SUBSTRING(@MaPhieuGiao, 4, LEN(@MaPhieuGiao)) AS INT)
			SET @STT = @STT + 1
			SET @MaPhieuGiao = 'PG-' + CONVERT(VARCHAR(7), @STT)
			--
			INSERT INTO PhieuGiao
				VALUES(@IdPhieuGiao, @MaPhieuGiao, '', @IdTaiKhoan, @DiaChi, GETDATE(), '', @TongTien, NULL, N'Đang chuẩn bị')
		END
		--Thêm vào chi tiết--
		DECLARE @IdSizeSanPham UNIQUEIDENTIFIER
		DECLARE @SoLuong INT	
		DECLARE @Gia FLOAT
		--
		DECLARE CUR CURSOR FOR
		SELECT IdSizeSanPham, SoLuong, Gia
		FROM ChiTietPhieuDat
		WHERE IdPhieuDat = @IdPhieuDat
		--
		OPEN CUR
		FETCH NEXT FROM CUR INTO @IdSizeSanPham, @SoLuong, @Gia
		WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO ChiTietPhieuGiao
				VALUES(@IdPhieuGiao, @IdSizeSanPham, @SoLuong, @Gia)
			--
			FETCH NEXT FROM CUR INTO @IdSizeSanPham, @SoLuong, @Gia
		END
		CLOSE CUR
		DEALLOCATE CUR
	END
GO

CREATE TRIGGER TG_CapNhatTinhTrang_DonHang ON ChiTietDonHang AFTER UPDATE
AS
	DECLARE @IdDonHang UNIQUEIDENTIFIER
	DECLARE @TongChiTietDonHang INT
	DECLARE @TongChiTietDonHangDaXuLy INT
	--
	SELECT @IdDonHang = IdDonHang
	FROM inserted
	--
	SELECT @TongChiTietDonHang = COUNT(*)
	FROM ChiTietDonHang
	WHERE IdDonHang = @IdDonHang
	--
	SELECT @TongChiTietDonHangDaXuLy = COUNT(*)
	FROM ChiTietDonHang
	WHERE IdDonHang = @IdDonHang AND TinhTrangChiTiet = N'Đã xử lý'
	--
	IF(@TongChiTietDonHang = @TongChiTietDonHangDaXuLy)
	BEGIN
		UPDATE DonHang
		SET	TinhTrang = N'Đã xử lý'
		WHERE Id = @IdDonHang
	END
GO

CREATE TRIGGER TG_CapNhatTinhTrangDanhGiaCustumer_DonHang ON ChiTietDonHang AFTER UPDATE
AS
	DECLARE @IdDonHang UNIQUEIDENTIFIER
	DECLARE @TongChiTietDonHang INT
	DECLARE @TongChiTietDonHangDaDanhGia INT
	--
	SELECT @IdDonHang = IdDonHang
	FROM inserted
	--
	SELECT @TongChiTietDonHang = COUNT(*)
	FROM ChiTietDonHang
	WHERE IdDonHang = @IdDonHang
	--
	SELECT @TongChiTietDonHangDaDanhGia = COUNT(*)
	FROM ChiTietDonHang
	WHERE IdDonHang = @IdDonHang AND DiemMerchantDanhGia != 0
	--
	IF(@TongChiTietDonHang = @TongChiTietDonHangDaDanhGia)
	BEGIN
		UPDATE DonHang
		SET	TinhTrangDanhGiaCustomer = N'Đã đánh giá'
		WHERE Id = @IdDonHang
	END
GO